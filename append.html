<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map with Editable JSON and Line Update</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <style>
        #map {
            height: 500px;
            width: 100%;
        }

        .input-section {
            margin-bottom: 10px;
        }

        #live-coordinates {
            margin-top: 10px;
        }

        #crosshair-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background-color: white;
            padding: 5px;
            cursor: pointer;
            border: 1px solid black;
        }

        #json-data {
            margin-top: 20px;
            width: 100%;
            height: 150px;
        }

        .number-label {
            font-size: 12px;
            color: rgb(255, 255, 255);
            text-align: center;
            border-radius: 50%;
            padding: 2px;
        }
    </style>
</head>

<body>

    <h1>Map with Editable JSON and Line Update</h1>

    <div class="input-section">
        <label for="coords">Start Coordinates (lat, lng):</label>
        <input type="text" id="coords" placeholder="Enter coordinates as lat,lng">
        <br>


        <label for="direction">Direction:</label>
        <select id="direction">
            <option value="north">North</option>
            <option value="south">South</option>
            <option value="east">East</option>
            <option value="west">West</option>
        </select>
        <br>

        <label for="distance">Distance (feet):</label>
        <input type="number" id="distance" placeholder="Enter distance in feet">
        <br>

        <button onclick="drawLine()">Draw Line</button>
        <button onclick="updateLines()">Update Lines</button>
    </div>

    <div id="map"></div>
    <button id="crosshair-btn" onclick="getCenterCoordinates()">Get Center Coordinates</button>
    <button onclick="downloadJSON()">Download JSON File</button>

    <div id="live-coordinates">Coordinates: <span id="mouse-coordinates"></span></div>
    <div id="center-coordinates">Center Coordinates: <span id="center-coord"></span></div>
    <div id="end-coordinates">Line End Coordinates: <span id="end-coord"></span></div>
    <div class="input-section">
        <label for="coords">Start Coordinates (lat, lng):</label>
        <input type="text" id="coord" placeholder="Enter coordinates as lat,lng">
        <br>

        <label for="width">North and south length:</label>
        <input type="number" id="width" placeholder="Enter width in feet">
        <br>

        <label for="height">East and west length</label>
        <input type="number" id="height" placeholder="Enter height in feet">
        <br>

        <label for="murabba-number">Murabba Number:</label>
        <input type="text" id="murabba-number" placeholder="Enter Murabba Number">
        <button onclick="drawRectangle()">Draw Rectangle</button>
    </div>



    <!-- Editable textarea to show and modify the JSON data -->
    <textarea id="json-data">JSON data will appear here...</textarea>

    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script>
        // Initialize the map

        var map = L.map('map').setView([31.4187222, 72.2825785], 13);

        googleHybrid = L.tileLayer('http://{s}.google.com/vt?lyrs=s,h&x={x}&y={y}&z={z}', {
            maxZoom: 20,
            subdomains: ['mt0', 'mt1', 'mt2', 'mt3']
        });
        googleHybrid.addTo(map)
        var lineData = [];
        function drawRectangle() {
            try {
                // Get the starting coordinates from the input
                const coordInput = document.getElementById('coord').value.trim();
                const coordsArray = coordInput.split(',');

                if (coordsArray.length !== 2) {
                    alert('Please provide coordinates in "lat,lng" format');
                    return;
                }

                const lat = parseFloat(coordsArray[0]);
                const lng = parseFloat(coordsArray[1]);

                if (isNaN(lat) || isNaN(lng)) {
                    alert('Invalid coordinates.');
                    return;
                }

                // Get the width and height from the inputs
                const widthFeet = parseFloat(document.getElementById('width').value) || 0;
                const heightFeet = parseFloat(document.getElementById('height').value) || 0;
                const murabbaNumber = document.getElementById('murabba-number').value.trim();


                if (widthFeet <= 0 || heightFeet <= 0) {
                    alert('Width and height must be positive numbers.');
                    return;
                }

                if (!murabbaNumber) {
                    alert('Please enter a Murabba Number.');
                    return;
                }

                // Convert feet to meters
                const feetToMeters = 0.3048;
                const widthMeters = widthFeet * feetToMeters;
                const heightMeters = heightFeet * feetToMeters;

                // Calculate the rectangle corners
                const nw = [lat, lng]; // Northwest point (starting point)
                const ne = [lat, lng + widthMeters / (111320 * Math.cos(lat * Math.PI / 180))]; // Northeast
                const sw = [lat - heightMeters / 111320, lng]; // Southwest
                const se = [lat - heightMeters / 111320, lng + widthMeters / (111320 * Math.cos(lat * Math.PI / 180))]; // Southeast

                // Debug log the points
                console.log('NW:', nw, 'NE:', ne, 'SE:', se, 'SW:', sw);

                // Draw the rectangle on the map
                const rectangleCoordinates = [nw, ne, se, sw, nw]; // Complete the polygon by connecting back to NW

                const rectangle = L.polygon(rectangleCoordinates, {
                    color: 'red',
                    fillColor: 'transparent',
                    weight: 2
                }).addTo(map);

                // Calculate the center point of the rectangle
                const centerLat = (nw[0] + sw[0]) / 2;
                const centerLng = (nw[1] + ne[1]) / 2;

                // Add a marker with the Murabba Number at the center of the rectangle
                L.marker([centerLat, centerLng], {
                    icon: L.divIcon({
                        className: 'murabba-label',
                        html: `<div style="font-weight: bold; color: white; font-size: 14px;">${murabbaNumber}</div>`
                    })
                }).addTo(map);

                // Create the GeoJSON representation
                const geojsonData = {
                    type: 'Feature',
                    geometry: {
                        type: 'Polygon',
                        coordinates: [[nw, ne, se, sw, nw]] // GeoJSON coordinates are nested
                    },
                    properties: {
                        'murabba': murabbaNumber
                    }
                };
                lineData.push(geojsonData)
                // Add the GeoJSON to the textarea
                document.getElementById('json-data').value = JSON.stringify(lineData, null, 2);
            } catch (error) {
                console.error('An error occurred:', error.message);
            }
        }

        // // Fit map to rectangle bounds
        // map.fitBounds(bounds);

        // // Generate GeoJSON data for the rectangle
        // const geojsonData = {
        //     "type": "Feature",
        //     "properties": {},
        //     "geometry": {
        //         "type": "Polygon",
        //         "coordinates": [[
        //             [startLng, startLat],
        //             [eastLng, northLat],
        //             [eastLng, southLat],
        //             [westLng, southLat],
        //             [startLng, startLat] // Close the polygon
        //         ]]
        //     }
        // };
        // document.getElementById('json-data').value = JSON.stringify(geojsonData, null, 2);








        // var bounds = [
        //     [31.4187222, 72.2825785],  // Southwest corner
        //     [31.420, 72.284]           // Northeast corner
        // ];


        // // Draw the rectangle
        // var rectangle = L.rectangle(bounds, { color: '#ff0000', weight: 2, fillColor: "transparent", fillOpacity: 0 }).addTo(map);
        // let boxElements = [];

        // // Add click event handler to the rectangle
        // let boxesVisible = false;  // Track visibility state
        // let boxes = [];  // Array to store box references
        // let markers = []; // Array to store number markers

        // // Add click event handler to the rectangle
        // rectangle.on('click', function (e) {
        //     if (!boxesVisible) {
        //         // Create boxes if they don't exist
        //         const bounds = rectangle.getBounds();
        //         const north = bounds.getNorth();
        //         const south = bounds.getSouth();
        //         const east = bounds.getEast();
        //         const west = bounds.getWest();

        //         const latStep = (north - south) / 5;
        //         const lngStep = (east - west) / 5;

        //         // Create 25 boxes (5x5 grid)
        //         for (let row = 0; row < 5; row++) {
        //             for (let col = 0; col < 5; col++) {
        //                 const boxNorth = north - (row * latStep);
        //                 const boxSouth = boxNorth - latStep;
        //                 let boxWest = west + (col * lngStep);
        //                 let boxEast = boxWest + lngStep;

        //                 // Calculate number based on row (even/odd)
        //                 let number;
        //                 if (row % 2 === 0) {
        //                     number = row * 5 + col + 1;
        //                 } else {
        //                     number = (row * 5) + (5 - col);
        //                 }

        //                 // Create rectangle
        //                 const boxBounds = [[boxSouth, boxWest], [boxNorth, boxEast]];
        //                 const box = L.rectangle(boxBounds, {
        //                     color: 'yellow',
        //                     weight: 1,
        //                     fillOpacity: 0
        //                 }).addTo(map);
        //                 boxes.push(box);

        //                 box.on('click', () => {
        //                     // Remove all boxes and markers
        //                     boxes.forEach(box => map.removeLayer(box));
        //                     markers.forEach(marker => map.removeLayer(marker));
        //                     boxes = [];
        //                     markers = [];
        //                     boxesVisible = false;
        //                 })

        //                 // Add number label
        //                 const center = box.getBounds().getCenter();
        //                 const marker = L.marker(center, {
        //                     icon: L.divIcon({
        //                         className: 'number-label',
        //                         html: number.toString(),
        //                         iconSize: [20, 20]
        //                     })
        //                 }).addTo(map);
        //                 markers.push(marker);
        //             }
        //         }
        //         boxesVisible = true;
        //     }
        // });

        // Store references to layers
        var currentLineLayer = null;
        var lineLayers = [];  // Array to store multiple line layers

        // Initialize line data array to store drawn lines
        

        // Update live coordinates on mouse move
        map.on('mousemove', function (e) {
            document.getElementById('mouse-coordinates').textContent = e.latlng.lat.toFixed(5) + ", " + e.latlng.lng.toFixed(5);
        });

        // Get the center coordinates when crosshair button is clicked
        function getCenterCoordinates() {
            var center = map.getCenter();
            document.getElementById('center-coord').textContent = center.lat.toFixed(5) + ", " + center.lng.toFixed(5);
        }

        // Function to draw the line based on input values and append to JSON
        function drawLine() {
            // Get the input value for the coordinates
            var coords = document.getElementById("coords").value.trim();

            // Split the coordinates by comma
            var coordsArray = coords.split(",");

            if (coordsArray.length !== 2) {
                alert("Please provide coordinates in 'lat,lng' format");
                return;
            }

            var lat = parseFloat(coordsArray[0]);
            var lng = parseFloat(coordsArray[1]);

            var direction = document.getElementById("direction").value;
            var distanceInFeet = parseFloat(document.getElementById("distance").value);

            if (isNaN(lat) || isNaN(lng) || isNaN(distanceInFeet)) {
                alert("Please provide valid inputs");
                return;
            }

            // Convert feet to meters (1 foot = 0.3048 meters)
            var distanceInMeters = distanceInFeet * 0.3048;

            // Calculate the new coordinates based on direction
            var newLat = lat;
            var newLng = lng;

            if (direction === "north") {
                newLat += distanceInMeters / 111320;  // Latitude changes per meter
            } else if (direction === "south") {
                newLat -= distanceInMeters / 111320;
            } else if (direction === "east") {
                newLng += distanceInMeters / (111320 * Math.cos(lat * Math.PI / 180));  // Longitude changes based on latitude
            } else if (direction === "west") {
                newLng -= distanceInMeters / (111320 * Math.cos(lat * Math.PI / 180));
            }

            // Draw the new line on the map
            var latlngs = [
                [lat, lng],
                [newLat, newLng]
            ];

            var newLineLayer = L.polyline(latlngs, { color: 'red' }).addTo(map);
            lineLayers.push(newLineLayer);  // Store the new line layer

            map.setView([lat, lng], 13);  // Center the map on the starting point

            // Display the end coordinates
            document.getElementById('end-coord').textContent = newLat.toFixed(5) + ", " + newLng.toFixed(5);

            // Append line data to the JSON array
            var lineEntry = {
                start: { lat: lat, lng: lng },
                end: { lat: newLat, lng: newLng },
                direction: direction,
                distance: distanceInFeet
            };
            lineData.push(lineEntry);

            // Update the editable textarea with the JSON data
            document.getElementById('json-data').value = JSON.stringify(lineData, null, 2);
        }


        // Function to clear the existing lines on the map
        function clearLines() {
            for (var i = 0; i < lineLayers.length; i++) {
                map.removeLayer(lineLayers[i]);
            }
            lineLayers = [];  // Clear the array of layers
        }

        // Function to update the lines based on the JSON in the textarea
        function updateLines() {
            var jsonData = document.getElementById('json-data').value;

            try {
                // Parse the JSON data from the textarea
                var parsedData = JSON.parse(jsonData);

                // Clear existing lines on the map
                clearLines();

                // Iterate through the parsed data and draw the lines on the map
                parsedData.forEach(function (line) {
                    var latlngs = [
                        [line.start.lat, line.start.lng],
                        [line.end.lat, line.end.lng]
                    ];
                    var newLineLayer = L.polyline(latlngs, { color: 'blue' }).addTo(map);
                    lineLayers.push(newLineLayer);  // Store the new line layer
                });

                // Update the lineData array to match the new parsed data
                lineData = parsedData;

            } catch (e) {
                alert("Invalid JSON format. Please check your edits.");
            }
        }

        // Function to download JSON file, using the content of the editable textarea
        function downloadJSON() {
            var jsonData = document.getElementById('json-data').value;

            try {
                JSON.parse(jsonData);  // Validate JSON

                var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(jsonData);
                var downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "lines_data.json");
                document.body.appendChild(downloadAnchorNode);  // Required for Firefox
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            } catch (e) {
                alert("Invalid JSON format. Please check your edits.");
            }
        }
    </script>

</body>

</html>